<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BBC Good Food → Mealie</title>
<link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
  <h1>BBC Good Food → Mealie</h1>

  <!-- Crawl Controls -->
  <div class="card">
    <button onclick="startCrawl()">Start Crawl & Upload</button>
    <button onclick="cancelCrawl()">Cancel</button>
    <a href="/settings">Settings</a> | <a href="/recipes">Recipe History</a>
  </div>

  <!-- Crawl Progress -->
  <div class="card">
    <h2>Crawl Progress</h2>
    <div id="crawlBar"><div id="crawlInner">0%</div></div>
    <p id="crawlStatus">Recipes: 0 | Pages: 0</p>
  </div>

  <!-- Upload Progress -->
  <div class="card">
    <h2>Upload Progress</h2>
    <div id="uploadBar"><div id="uploadInner">0%</div></div>
    <p id="uploadStatus">0 / 0</p>
  </div>

  <!-- Live Recipes List -->
  <div class="card">
    <h2>Successfully Added Recipes</h2>
    <ul id="recipeList"></ul>
  </div>

  <!-- Download -->
  <div class="card">
    <a href="/download" target="_blank">Download Mealie URLs</a>
  </div>

  <!-- Version Info -->
  <div class="card">
    <p>Version: <span id="version">loading...</span></p>
    <p><a href="https://github.com/YOUR_USERNAME/YOUR_REPO" target="_blank">View on GitHub</a></p>
  </div>
</div>

<script>
let crawlInterval, uploadInterval, recipeInterval;

function startCrawl(){
    fetch('/start_crawl',{method:'POST'});
    crawlInterval=setInterval(updateCrawl,1000);
    uploadInterval=setInterval(updateUpload,1000);
    recipeInterval=setInterval(updateRecipes,2000);
}

function cancelCrawl(){
    fetch('/cancel');
    document.getElementById('crawlStatus').innerText="Cancelled";
    document.getElementById('uploadStatus').innerText="Cancelled";
}

async function updateCrawl(){
    const resp=await fetch('/progress/crawl');
    const data=await resp.json();
    let percent=Math.floor((data.recipes/(data.recipes+1))*100);
    document.getElementById('crawlInner').style.width=percent+'%';
    document.getElementById('crawlInner').innerText=percent+'%';
    document.getElementById('crawlStatus').innerText=`Recipes: ${data.recipes} | Pages: ${data.pages}`;
    if(data.status==='done') clearInterval(crawlInterval);
}

async function updateUpload(){
    const resp=await fetch('/progress/upload');
    const data=await resp.json();
    let percent=0;
    if(data.total>0) percent=Math.floor(data.index/data.total*100);
    document.getElementById('uploadInner').style.width=percent+'%';
    document.getElementById('uploadInner').innerText=percent+'%';
    document.getElementById('uploadStatus').innerText=`${data.index} / ${data.total}`;
    if(data.status==='done') clearInterval(uploadInterval);
}

async function updateRecipes(){
    const resp=await fetch('/progress/recipes');
    const data=await resp.json();
    const list=document.getElementById('recipeList');
    list.innerHTML="";
    data.recipes.forEach(url=>{
        const li=document.createElement("li");
        li.textContent=url;
        list.appendChild(li);
    });
}

// Version from GitHub Release
async function loadVersion(){
    try{
        let resp=await fetch('https://api.github.com/repos/YOUR_USERNAME/YOUR_REPO/releases/latest');
        let data=await resp.json();
        if(data && data.tag_name) document.getElementById('version').innerText=data.tag_name;
        else {
            resp=await fetch('https://api.github.com/repos/YOUR_USERNAME/YOUR_REPO/commits/main');
            data=await resp.json();
            document.getElementById('version').innerText=data.sha ? "commit "+data.sha.substring(0,7) : "unknown";
        }
    }catch(e){document.getElementById('version').innerText="error";}
}
loadVersion();
</script>
</body>
</html>
