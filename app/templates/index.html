<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BBC Good Food → Mealie</title>
<link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
  <h1>BBC Good Food → Mealie</h1>

  <!-- Mealie API Settings -->
  <div class="card">
    <h2>Mealie API Settings</h2>
    <label>API URL:</label>
    <input type="text" id="mealie_url" placeholder="http://localhost:9000/api/recipes/import"><br>
    <label>API Key:</label>
    <input type="text" id="api_key" placeholder="your_api_key_here"><br>
    <label>Rate Limit (s):</label>
    <input type="number" id="rate_limit" value="2" min="0.1" step="0.1"><br><br>
    <button onclick="startCrawl()">Start Crawl & Upload</button>
    <button onclick="cancelCrawl()">Cancel</button>
  </div>

  <!-- Crawl Progress -->
  <div class="card">
    <h2>Crawl Progress</h2>
    <div id="crawlBar"><div id="crawlInner">0%</div></div>
    <p id="crawlStatus">Recipes: 0 | Pages: 0</p>
  </div>

  <!-- Upload Progress -->
  <div class="card">
    <h2>Upload Progress</h2>
    <div id="uploadBar"><div id="uploadInner">0%</div></div>
    <p id="uploadStatus">0 / 0</p>
  </div>

  <!-- Successfully Added Recipes -->
  <div class="card">
    <h2>Successfully Added Recipes</h2>
    <ul id="recipeList"></ul>
  </div>

  <div class="card">
    <a href="/download" target="_blank">Download Mealie URLs</a>
  </div>

  <!-- Version Info -->
  <div class="card">
    <p>Version: <span id="version">loading...</span></p>
    <p><a href="https://github.com/YOUR_USERNAME/YOUR_REPO" target="_blank">View on GitHub</a></p>
  </div>
</div>

<script>
let crawlInterval, uploadInterval, recipeInterval;

// Start Crawl
function startCrawl(){
    const payload = {
        mealie_url: document.getElementById('mealie_url').value,
        api_key: document.getElementById('api_key').value,
        rate_limit: parseFloat(document.getElementById('rate_limit').value)
    };
    fetch('/start_crawl', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
    });
    crawlInterval=setInterval(updateCrawl,1000);
    uploadInterval=setInterval(updateUpload,1000);
    recipeInterval=setInterval(updateRecipes,2000);
}

// Cancel Crawl/Upload
function cancelCrawl(){
    fetch('/cancel');
    document.getElementById('crawlStatus').innerText="Cancelled";
    document.getElementById('uploadStatus').innerText="Cancelled";
}

// Crawl Progress Update
async function updateCrawl(){
    const resp=await fetch('/progress/crawl');
    const data=await resp.json();
    let percent=Math.floor((data.recipes/(data.recipes+1))*100);
    document.getElementById('crawlInner').style.width=percent+'%';
    document.getElementById('crawlInner').innerText=percent+'%';
    document.getElementById('crawlStatus').innerText=`Recipes: ${data.recipes} | Pages: ${data.pages}`;
    if(data.status==='done') clearInterval(crawlInterval);
}

// Upload Progress Update
async function updateUpload(){
    const resp=await fetch('/progress/upload');
    const data=await resp.json();
    let percent=0;
    if(data.total>0) percent=Math.floor(data.index/data.total*100);
    document.getElementById('uploadInner').style.width=percent+'%';
    document.getElementById('uploadInner').innerText=percent+'%';
    document.getElementById('uploadStatus').innerText=`${data.index} / ${data.total}`;
    if(data.status==='done') clearInterval(uploadInterval);
}

// Live Recipe List Update
async function updateRecipes(){
    const resp=await fetch('/progress/recipes');
    const data=await resp.json();
    const list = document.getElementById('recipeList');
    list.innerHTML="";
    data.recipes.forEach(url=>{
        const li=document.createElement("li");
        li.textContent=url;
        list.appendChild(li);
    });
}

// Load Version Info from GitHub
async function loadVersion(){
    try {
        const resp = await fetch('https://api.github.com/repos/nthonyhales/bbc_goodfood_docker/releases/latest');
        const data = await resp.json();
        if(data && data.tag_name){
            document.getElementById('version').innerText = data.tag_name;
        } else {
            document.getElementById('version').innerText = "unknown";
        }
    } catch(e){
        document.getElementById('version').innerText = "error";
    }
}
loadVersion();
</script>
</body>
</html>


